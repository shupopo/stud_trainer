<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Seven Card Stud - Hand Eval 完全版</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #132020; color: white; }
    .hand { display: flex; margin-bottom: 10px; }
    .card { border: 1px solid white; padding: 10px; margin-right: 5px; background: white; color: black; }
    button { padding: 10px; margin-right: 10px; }
    .log { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Seven Card Stud（完全役判定対応）ss</h1>

  <h2>CPUの手札</h2>
  <div id="cpu-hand" class="hand"></div>

  <h2>あなたの手札</h2>
  <div id="player-hand" class="hand"></div>

  <div>
    <button onclick="playerAction('fold')">Fold</button>
    <button onclick="playerAction('call')">Call</button>
    <button onclick="playerAction('raise')">Raise</button>
  </div>

  <div class="log" id="log"></div>

  <script>
    const suits = ['♠','♥','♦','♣'];
    const ranks = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];

    const deck = [];
    suits.forEach(suit => {
      ranks.forEach(rank => {
        deck.push(suit + rank);
      });
    });

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function dealHand(deck, count) {
      return deck.splice(0, count);
    }

    function renderHand(containerId, cards) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      cards.forEach(card => {
        const div = document.createElement('div');
        div.className = 'card';
        div.textContent = card;
        container.appendChild(div);
      });
    }

    function getVal(card) {
      const r = card.slice(1);
      if (r === 'J') return 11;
      if (r === 'Q') return 12;
      if (r === 'K') return 13;
      if (r === 'A') return 14;
      return parseInt(r);
    }

    function evaluateHand(cards) {
      const suits = {};
      const ranks = {};
      const values = [];

      cards.forEach(card => {
        const suit = card[0];
        const val = getVal(card);
        values.push(val);
        suits[suit] = (suits[suit] || []);
        suits[suit].push(val);
        ranks[val] = (ranks[val] || 0) + 1;
      });

      const sortedVals = [...new Set(values)].sort((a, b) => a - b);
      const rankCounts = Object.values(ranks).sort((a, b) => b - a);

      function isStraight(vals) {
        vals = [...new Set(vals)].sort((a, b) => a - b);
        for (let i = 0; i <= vals.length - 5; i++) {
          const slice = vals.slice(i, i + 5);
          if (slice[4] - slice[0] === 4 &&
              slice.every((v, idx, arr) => idx === 0 || v === arr[idx-1] + 1)) {
            return true;
          }
        }
        if (vals.includes(14)) {
          const lowStraight = [2,3,4,5];
          if (lowStraight.every(v => vals.includes(v))) return true;
        }
        return false;
      }

      const flushSuit = Object.keys(suits).find(s => suits[s].length >= 5);
      const flushVals = flushSuit ? suits[flushSuit] : [];

      if (flushSuit && isStraight(flushVals)) return 'Straight Flush';
      if (rankCounts[0] === 4) return 'Four of a Kind';
      if (rankCounts[0] === 3 && rankCounts[1] >= 2) return 'Full House';
      if (flushSuit) return 'Flush';
      if (isStraight(values)) return 'Straight';
      if (rankCounts[0] === 3) return 'Three of a Kind';
      if (rankCounts[0] === 2 && rankCounts[1] === 2) return 'Two Pair';
      if (rankCounts[0] === 2) return 'One Pair';
      return 'High Card';
    }

    function getStrengthLevel(rank) {
      switch(rank) {
        case 'Straight Flush':
        case 'Four of a Kind':
        case 'Full House': return 'strong';
        case 'Flush':
        case 'Straight':
        case 'Three of a Kind': return 'medium';
        case 'Two Pair':
        case 'One Pair': return 'weak';
        default: return 'very weak';
      }
    }

    function cpuActionByStrength(strength) {
      const rnd = Math.random();
      if (strength === 'strong') return rnd < 0.8 ? 'raise' : 'call';
      if (strength === 'medium') return rnd < 0.7 ? 'call' : 'fold';
      if (strength === 'weak') return rnd < 0.5 ? 'call' : 'fold';
      return 'fold';
    }

    function logMessage(msg) {
      const log = document.getElementById('log');
      log.innerHTML += `<p>${msg}</p>`;
    }

    // 初期処理
    let deckState = shuffle([...deck]);
    const cpuHand = dealHand(deckState, 7);
    const playerHand = dealHand(deckState, 7);

    renderHand('cpu-hand', cpuHand);
    renderHand('player-hand', playerHand);

    const cpuRank = evaluateHand(cpuHand);
    const playerRank = evaluateHand(playerHand);
    const cpuStrength = getStrengthLevel(cpuRank);
    const cpuMove = cpuActionByStrength(cpuStrength);

    logMessage(`CPUの手札評価: ${cpuRank}`);
    logMessage(`CPUの行動: ${cpuMove.toUpperCase()}`);

    function playerAction(action) {
      logMessage(`あなたの行動: ${action.toUpperCase()}`);
      logMessage(`あなたの手札評価: ${playerRank}`);

      const rankOrder = [
        'High Card',
        'One Pair',
        'Two Pair',
        'Three of a Kind',
        'Straight',
        'Flush',
        'Full House',
        'Four of a Kind',
        'Straight Flush'
      ];

      const cpuScore = rankOrder.indexOf(cpuRank);
      const playerScore = rankOrder.indexOf(playerRank);

      if (cpuScore > playerScore) {
        logMessage('CPUの勝ち！');
      } else if (playerScore > cpuScore) {
        logMessage('あなたの勝ち！');
      } else {
        logMessage('引き分けです！');
      }
    }
  </script>
</body>
</html>